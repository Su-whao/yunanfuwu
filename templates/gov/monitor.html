<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>云安服务</title>
    <meta name="description" content="Ela Admin - HTML5 Admin Template">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <link rel="stylesheet" href="/static/assets/css/normalize.css">
<link rel="stylesheet" href="/static/assets/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="/static/assets/css/themify-icons.css">
<link rel="stylesheet" href="/static/assets/css/pe-icon-7-filled.css">
    <link rel="stylesheet" href="/static/assets/css/flag-icon.min.css"><link rel="stylesheet" href="/static/assets/css/cs-skin-elastic.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqvmap/1.5.1/jqvmap.min.css">
    <link rel="stylesheet" href="/static/assets/css/style.css">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>

   <style>
        .amap-icon img,
        .amap-marker-content img{
            width: 45px;
            height: 45px;
        }
    </style>
</head>
<body>
    <!-- Left Panel -->

    <aside id="left-panel" class="left-panel">
        <nav class="navbar navbar-expand-sm navbar-default">

            <div id="main-menu" class="main-menu collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="#" gaode_center='{{ base.city.center }}' onclick="changeDistrict(this)"><i class="menu-icon fa fa-laptop"></i>设备监控 </a>
                    </li>
                    
                    <li class="menu-title">设备监控</li><!-- /.menu-title -->

                
                    <li class="menu-item-has-children active dropdown">
                        <a  id='{{ base.city.adcode }}' href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-area-chart"></i>{{ base.city.name }}</a>
                        <ul class="sub-menu children dropdown-menu">
                            {% for d in base.city.districts %}
                                <li id='{{d.adcode}}' gaode_center='{{ d.center }}' onclick="changeDistrict(this)" ><i class="menu-icon fa fa-street-view"></i><a href="#">{{ d.name }}</a></li>
                            {% endfor %}
                        </ul>
                    </li>
                    
                </ul>
            </div><!-- /.navbar-collapse -->
        </nav>
    </aside><!-- /#left-panel -->

    <!-- Left Panel -->

    <!-- Right Panel -->

    <div id="right-panel" class="right-panel">

        <!-- Header-->
        <header id="header" class="header">
            <div class="top-left">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#" gaode_center='{{ base.city.center }}' onclick="changeDistrict(this)" ><img style="height: 50px" src="/static/img/yunan_logo_2.png" alt="Logo"></a>
                    <a id="menuToggle" class="menutoggle"><i class="fa fa-bars"></i></a>
                </div>
            </div>
            <div class="top-right">
                <div class="header-menu">

                    <div class="user-area dropdown float-right">
                        <a href="#" class="dropdown-toggle active" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                           <p class="">{{ base.gov_name }}</p>
                        </a>

                        <div class="user-menu dropdown-menu">
                            <a class="nav-link" href="#"><i class="fa fa-user"></i>账号信息</a>

                            <a class="nav-link" href="#"><i class="fa fa-cog"></i>账号设置</a>

                            <a class="nav-link" href="#"><i class="fa fa-power-off"></i>退出</a>
                        </div>
                    </div>
                </div>
            </div>
        </header><!-- /header -->
        <!-- Header-->

        <div class="content">
            <div class="animated fadeIn">

             <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="Vector-map-js">
                            <div id="vmap" class="vmap" ></div>
                        </div>
                    </div>
                    <!-- /# card -->
                </div>
                <!-- /# column -->
            </div>
            <!-- /# row -->


        </div><!-- .animated -->
    </div><!-- .content -->

    <div class="clearfix"></div>

    <footer class="site-footer">
        <div class="footer-inner bg-white">
            <div class="row">
                <div class="col-sm-6">
                    Copyright &copy; 云安服务 
                </div>
                <div class="col-sm-6 text-right"> 理智团队
                </div>
            </div>
        </div>
    </footer>

</div><!-- /#right-panel -->

<!-- Right Panel -->

<!-- Scripts -->
<script src="/static/assets/js/vendor/jquery-2.1.4.min.js"></script>
<script src="/static/assets/js/popper.min.js"></script>
<script src="/static/assets/js/bootstrap.min.js"></script>
<script src="/static/assets/js/jquery.matchHeight.min.js"></script>
<script src="/static/assets/js/main.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.8&key=efb66f1d0e0a897af3702fdb233c0812"></script>

<script type="text/javascript">
    let height = (window.innerHeight*0.75).toString()+'px';
    document.getElementById('vmap').style.height = height;

    window.onresize=function(){  
      let height = (window.innerHeight*0.75).toString()+'px';
      document.getElementById('vmap').style.height = height; 
    }



</script>


<script>
    //  地图对象
    let gaode_longitude = {{ base.gaode_longitude }}
    let gaode_latitude = {{ base.gaode_latitude }}
    var map = new AMap.Map('vmap',
            {
                center:[ gaode_longitude , gaode_latitude],
                // 缩放度
                zoom:12
            }
    );
    // 设备列表
    var positions = [ 
            {% for e in equipments %}
            [
                { 'lng': {{ e.gaode_longitude }},  // 经度
                  'lnt': {{ e.gaode_latitude }},    // 维度
                  'state': '001',   // 状态，根据状态调图片
                  'eid': '{{ e.id }}' 
                }
            ],
            {% endfor %}
        ]
    // 标注列表
    var markers = [];
    if (positions.length) {
       for(var i=0; i < positions.length; i += 1){
           var pictures =  {'001':'/static/img/mapPoint/blue.png', '102':'/static/img/mapPoint/yellow.png', '101':'/static/img/mapPoint/red.png'};  // 标点图片
           var marker = new AMap.Marker({
                      // 经纬度
                  position:[positions[i][0]['lng'], positions[i][0]['lnt']],
                  // 图片
                  icon: pictures[positions[i][0]['state']],
                  // 偏移量
                  offset: new AMap.Pixel(-13, -36),
                  // 设置是否可拖拽
                  draggable: false,
            });
            // 设置点标记的动画效果，此处为弹跳效果
            marker.setAnimation('AMAP_ANIMATION_BOUNCE');
            markers.push(marker);
            positions[i].push(marker)
                
        }
        map.add(markers);

    }

    // 选择地区
    function changeDistrict(e) {
        let gaode_center = e.getAttribute("gaode_center");
        gaode_center = gaode_center.split(',')
        let gaode_longitude = parseFloat(gaode_center[0])
        let gaode_latitude = parseFloat(gaode_center[1])

        var zoom = 12;
        map.setZoomAndCenter(zoom, [gaode_longitude, gaode_latitude]); //同时设置地图层级与中心点
    }

    // socket
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    socket.on('connect', function(data) {
        console.log('--> Client connect successed', data)
    });
    // 报警
    socket.on('report', function(data, callback) {
        console.log(data);
        let eid = data['reporter']
        
        // 更改点标记
        if (data.code == '101') {
            for (let i = 0 ; i < positions.length ; i++) {
                if (positions[i][0]['eid'] == eid) {
                    positions[i][1].setIcon('/static/img/mapPoint/red.png')
                }
            }
        } else if (data.code == '102'){
            for (let i = 0 ; i < positions.length ; i++) {
                if (positions[i][0]['eid'] == eid) {
                    positions[i][1].setIcon('/static/img/mapPoint/yellow.png')
                }
            }
        } else if (data.code.startsWith('0')) {
            for (let i = 0 ; i < positions.length ; i++) {
                if (positions[i][0]['eid'] == eid) {
                    positions[i][1].setIcon('/static/img/mapPoint/blue.png')
                }
            }
        }

        callback(1)
    })
    socket.on('join', function(data, callback) {
        console.log(data)
        
    })
    socket.on('jump', function(data, callback) {
        console.log(data)
        callback(1)
    })


</script>


</body>
</html>
